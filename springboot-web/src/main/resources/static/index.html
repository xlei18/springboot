<script src="/webjars/jquery/jquery.min.js"></script>
<script src="/webjars/sockjs-client/sockjs.min.js"></script>
<script src="/webjars/stomp-websocket/stomp.min.js"></script>
</head>
<script>
    var stompClient = null;

    $(function() {
        startServer();
    })

    function startServer() {
        var url = 'http://localhost:8080'
        var socket = new SockJS(url);
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function(frame) {
            //初始化
            stompClient.subscribe('/msg/init/' + userId, function (initData) {
                console.log(initData);
                var body = JSON.parse(initData.body);
                var chat = body.chat;
                chat.forEach(function(item) {
                    showChat(item);
                });
            });
            //广播回调
            stompClient.subscribe('/topic/live', function(message){
                var json = JSON.parse(message.body);
                showChat(json);
            });
            //广播方式实现点对点回调
            stompClient.subscribe('/topic/point' + userId, function (message) {
                var json = JSON.parse(message.body);
                showChat(json);
            });
            //点对点方式回调
            stompClient.subscribe('/user/' + userId + '/message', function(message){
                var json = JSON.parse(message.body);
                showChat(json);
            });
        });

    }

    function closeServer() {
        if (stompClient != null) {
            stompClient.disconnect();
        }
    }

    function sendTopic() {
        var input = $('#topic_input');
        var inputValue = input.val();
        input.val("");
        stompClient.send("/msg/live", {}, JSON.stringify({
            'name' : encodeURIComponent('广播'),
            'msg' : encodeURIComponent(inputValue)
        }));
    }

    function sendPoint() {
        var input = $('#point_input');
        var inputValue = input.val();
        input.val("");
        stompClient.send("/msg/point", {}, JSON.stringify({
            'name' : encodeURIComponent('广播点对点'),
            'msg': encodeURIComponent(inputValue),
            'coordinationId': 1
        }));
    }

    function sendUser() {
        var input = $('#user_input');
        var inputValue = input.val();
        input.val("");
        stompClient.send("/msg/message", {}, JSON.stringify({
            'name' : encodeURIComponent('点对点'),
            'msg': encodeURIComponent(inputValue),
            'coordinationId': 'a'
        }));
    }

    function showChat(message) {
        var value = decodeURIComponent(message.name) + ':' + decodeURIComponent(message.msg) + '\n';
        var content = $("#topic_content").val() + value;
        $("#topic_content").val(content);
    }
</script>
<body>
<div>
    <input id="topic_input" type="text">
    <input type="button" onclick="sendTopic();" value="send广播">
</div>

<div>
    <input id="point_input" type="text">
    <input type="button" onclick="sendPoint();" value="send广播点对点">
</div>

<div>
    <input id="user_input" type="text">
    <input type="button" onclick="sendUser();" value="send点对点">
</div>

<div>
    <textarea id="topic_content" style="width:200px;height:80px;"></textarea>
</div>
</body>
</html>